import{a as r}from"./chunk-NKWKUKJX.js";import{c as m}from"./chunk-X6BUMP3A.js";import{a as f}from"./chunk-GCRTNX5W.js";import{I as p,a as o,ga as h,ka as g,m as u,pa as a,s as c,x as i}from"./chunk-OVOXXI53.js";var b=class n{constructor(e,t){this.router=e;this.http=t;this.userSubject=new u(JSON.parse(localStorage.getItem("user"))),this.user=this.userSubject.asObservable()}userSubject;user;accessToken=null;isRefreshing=!1;refreshTokenSubject=new u(null);get userValue(){return this.userSubject.value}login(e,t){return this.http.post(`${r.apiUrl}/authentication/login`,{email:e,password:t}).pipe(i(s=>(localStorage.setItem("userToken",JSON.stringify(s)),localStorage.setItem("userName",e.substring(0,e.indexOf("@"))),this.userSubject.next(s),s)))}logout(){localStorage.removeItem("userToken"),localStorage.removeItem("userName"),this.userSubject.next(null),this.router.navigate(["/account/login"])}register(e){return this.http.post(`${r.apiUrl}/users/register`,e)}getAll(){return this.http.get(`${r.apiUrl}/users`)}getByEmail(e){return this.http.get(`${r.apiUrl}/users/${e}`)}update(e,t){return this.http.put(`${r.apiUrl}/users/${e}`,t).pipe(i(s=>{if(e==this.userValue?.email){let l=o(o({},this.userValue),t);localStorage.setItem("user",JSON.stringify(l)),this.userSubject.next(l)}return s}))}refreshToken(){return this.isRefreshing?this.refreshTokenSubject.asObservable().pipe(i(e=>e?{accessToken:e}:null)):(this.isRefreshing=!0,this.http.post("/authentication/refresh",{},{withCredentials:!0}).pipe(h(e=>{this.setAccessToken(e.accessToken),this.refreshTokenSubject.next(e.accessToken),this.isRefreshing=!1}),p(e=>(this.isRefreshing=!1,this.logout(),c(null)))))}setAccessToken(e){this.accessToken=e}getAccessToken(){let e=localStorage.getItem("userToken");return e?JSON.parse(e).token:this.accessToken}delete(e){return this.http.delete(`${r.apiUrl}/users/${e}`).pipe(i(t=>(e==this.userValue?.email&&this.logout(),t)))}static \u0275fac=function(t){return new(t||n)(a(m),a(f))};static \u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})};export{b as a};
